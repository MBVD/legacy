
### Замена кода программ

В UNIX-системах существует два способа частичной или полной замены кода процесса: с помощью системных вызовов `mmap` и `execve`. Эти механизмы позволяют изменять или полностью заменять содержимое виртуальной памяти процесса новыми данными или кодом.

#### Частичная замена: `mmap`

Системный вызов `mmap` позволяет отображать содержимое файлов или областей памяти в виртуальное адресное пространство процесса.

- **Механизм работы `mmap`**: 
  - Виртуальная память процесса представляет собой набор страниц, которые могут быть связаны с файлами на диске. `mmap` отображает содержимое файла в виртуальную память, связывая её с соответствующими страницами в оперативной памяти.
  - Например, если файл на диске содержит какой-то набор данных, можно сделать так, чтобы определённая область виртуальной памяти процесса "смотрела" на этот файл. Таким образом, при обращении к этой области памяти будет происходить чтение или запись в файл.

- **Параметры `mmap`**:
  1. **Адрес**: Указывает, по какому адресу в виртуальной памяти должно происходить отображение. Если указать `NULL`, ядро самостоятельно выберет адрес.
  2. **Протоколы (права доступа)**: Определяют, какие операции могут выполняться с отображённой памятью (`PROT_READ`, `PROT_WRITE`, `PROT_EXEC`). Эти права должны соответствовать тем, с которыми открыт файл.
  3. **Флаги отображения**:
     - `MAP_SHARED`: Изменения в памяти будут отображаться обратно в файл.
     - `MAP_PRIVATE`: Изменения в памяти не будут записываться в файл (copy-on-write).
     - `MAP_ANONYMOUS`: Используется для создания анонимной области памяти, не связанной с файлом на диске.
  4. **Размер отображаемой области**: Определяет, сколько байт файла будет отображено в виртуальную память.
  5. **Смещение**: Указывает начальную точку в файле, откуда начинается отображение. Должно быть кратно размеру страницы.
  6. **Файловый дескриптор**: Указывает на файл, содержимое которого отображается. В случае использования `MAP_ANONYMOUS` файловый дескриптор устанавливается в `-1`.

- **Ленивое отображение (lazy mapping)**: 
  - При ленивом отображении реальное связывание страниц происходит только в момент обращения к ним (copy-on-write). Это экономит ресурсы, так как физическая память выделяется только по мере необходимости.
  
- **Синхронизация и управление**:
  - `msync`: Принудительная синхронизация содержимого памяти с файлом на диске.
  - `munmap`: Удаление отображения памяти. Необходимо для корректного освобождения ресурсов.

`mmap` — мощный инструмент, позволяющий динамически управлять виртуальной памятью процесса, но требует тщательного контроля, так как неправильное использование может привести к ошибкам, таким как `segmentation fault`.

![[Drawing 2024-09-24 14.26.32.excalidraw.png]]

#### Полная замена: `execve`

Системный вызов `execve` позволяет полностью заменить код и данные текущего процесса новыми, загружая в его тело новую программу.

- **Назначение `execve`**: 
  `execve` запускает новую программу в теле существующего процесса, полностью заменяя его виртуальное адресное пространство.

- **Параметры `execve`**:
  1. **Путь к исполняемому файлу**: Указывает файл, который будет загружен и исполнен.
  2. **Аргументы командной строки** (`argv`): Массив строк, передаваемых новой программе. Последний элемент массива должен быть `NULL`.
  3. **Переменные окружения** (`env`): Набор строк вида `"имя_переменной=значение"`, также заканчивающийся `NULL`.

- **Механизм работы `execve`**:
  - Виртуальная память процесса полностью очищается и заменяется новой памятью, загруженной из исполняемого файла.
  - Код новой программы начинает выполняться с метки `_start`, которая указывает на начальную точку исполнения.

- **Переменные окружения**:
  - Используются для передачи информации в новую программу, например:
    - `PATH`: Пути поиска исполняемых файлов.
    - `HOME`: Домашний каталог пользователя.
    - `LD_LIBRARY_PATH`: Пути поиска динамически загружаемых библиотек.
  - Переменные окружения могут быть получены и изменены с помощью функций `getenv` и `setenv`.

- **Работа с аргументами**:
  - Аргументы командной строки и переменные окружения передаются через стек, что позволяет программе получать доступ к ним через параметры функции 
  `main(int argc, char **argv, char **env)`.

![[Drawing 2024-09-24 15.10.09.excalidraw 2.png]]

`execve` полностью заменяет содержимое процесса, включая стек, кучу, данные и код. После вызова `execve` исходная программа перестаёт существовать, и её выполнение продолжается с новой программы.

### SUID-биты

Флаги `suid` и `sgid` позволяют временно изменять права доступа к файлам при выполнении программы:

1. **`suid` (set-user-ID)**: 
   - Если установлен для файла, программа будет выполняться с правами владельца файла, а не с правами пользователя, который её запустил.
   - Пример: Выполнение программы `passwd` с правами суперпользователя для изменения пароля.

2. **`sgid` (set-group-ID)**:
   - Программа выполняется с правами группы владельца файла.

Эти механизмы обеспечивают безопасность и ограничение доступа, позволяя временно повысить права доступа, когда это необходимо.